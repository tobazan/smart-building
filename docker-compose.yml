version: '3.8'

services:
  # MQTT Broker - NanoMQ
  nanomq:
    image: emqx/nanomq:latest
    container_name: smart-building-nanomq
    ports:
      - "1883:1883"    # MQTT
      - "8081:8081"    # HTTP API & Statistics
      - "8083:8083"    # WebSocket
    volumes:
      - ./config/nanomq.conf:/etc/nanomq.conf:ro
    networks:
      - smart-building
    restart: unless-stopped

  # Sensor Simulator with BACnet/Modbus servers
  sensor-simulator:
    build:
      context: ./sensor-simulator
      dockerfile: Dockerfile
    container_name: smart-building-sensor-simulator
    ports:
      - "47808:47808/udp"  # BACnet
      - "5020:5020"        # Modbus TCP
    volumes:
      - ./config:/app/config:ro
    networks:
      - smart-building
    restart: unless-stopped

  # Golang Gateway - Protocol to MQTT bridge
  golang-gateway:
    build:
      context: ./golang-gateway
      dockerfile: Dockerfile
    container_name: smart-building-golang-gateway
    environment:
      - MQTT_BROKER=tcp://nanomq:1883
      - SENSORS_CONFIG=/app/config/sensors.yaml
      - ROOMS_CONFIG=/app/config/rooms.yaml
    volumes:
      - ./config:/app/config:ro
    networks:
      - smart-building
    depends_on:
      - nanomq
      - sensor-simulator
    restart: unless-stopped

  # eKuiper - Stream Processing for Downsampling
  ekuiper:
    image: lfedge/ekuiper:latest
    container_name: smart-building-ekuiper
    ports:
      - "9081:9081"  # REST API
      - "20498:20498"  # Management console
    volumes:
      - ./ekuiper/etc/init.json:/kuiper/etc/init.json:ro
      - ./ekuiper/etc/mqtt_source.yaml:/kuiper/etc/mqtt_source.yaml:ro
    environment:
      - MQTT_BROKER=tcp://nanomq:1883
    networks:
      - smart-building
    depends_on:
      - nanomq
    restart: unless-stopped

  # Telegraf - MQTT to InfluxDB Bridge
  telegraf:
    image: telegraf:latest
    container_name: smart-building-telegraf
    volumes:
      - ./config/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    networks:
      - smart-building
    depends_on:
      - nanomq
      - influxdb
    restart: unless-stopped

  # InfluxDB - Time-Series Database
  influxdb:
    image: influxdb:2.7
    container_name: smart-building-influxdb
    ports:
      - "8086:8086"
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2
      - ./influxdb/init/init-influxdb.sh:/init-influxdb.sh:ro
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin123456
      - DOCKER_INFLUXDB_INIT_ORG=smart-building
      - DOCKER_INFLUXDB_INIT_BUCKET=sensor_data
      - DOCKER_INFLUXDB_INIT_RETENTION=30d
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=smart-building-token-2026
    networks:
      - smart-building
    restart: unless-stopped

  # Grafana - Visualization and Dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: smart-building-grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=
    networks:
      - smart-building
    depends_on:
      - influxdb
    restart: unless-stopped

  # Parquet Golang Bridge - MQTT to Parquet Writer
  parquet-golang-bridge:
    build:
      context: ./golang-bridge
      dockerfile: Dockerfile
    container_name: smart-building-golang-bridge
    volumes:
      - ./data/parquet:/data/parquet
    environment:
      - MQTT_BROKER=nanomq
      - MQTT_PORT=1883
      - OUTPUT_DIR=/data/parquet
      - OUTPUT_FORMAT=parquet
      - FLUSH_INTERVAL_SEC=60
      - FILE_ROTATION_SEC=300
    networks:
      - smart-building
    depends_on:
      - nanomq
      - ekuiper
    restart: unless-stopped

volumes:
  influxdb-data:
  influxdb-config:
  grafana-data:

networks:
  smart-building:
    driver: bridge