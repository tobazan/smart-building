# Telegraf Configuration for Smart Building MQTT to InfluxDB

[agent]
  interval = "5s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "5s"
  flush_jitter = "0s"
  precision = ""
  hostname = ""
  omit_hostname = false

## ------------------------------------------------------------
## INPUTS
## ------------------------------------------------------------

# MQTT Consumer - Subscribe to downsampled telemetry topics
[[inputs.mqtt_consumer]]
  servers = ["tcp://nanomq:1883"]
  topics = ["ds_telemetry/#"]
  qos = 1
  client_id = "telegraf-mqtt-consumer"
  data_format = "json"
  name_override = "sensor_telemetry"
  json_string_fields = ["room_id"]
  json_time_key = "timestamp"
  json_time_format = "2006-01-02T15:04:05Z07:00"
  json_timezone = "UTC"
  tag_keys = ["room_id"]

# eKuiper Rules Status - HTTP JSON Input
[[inputs.http]]
  interval = "15s"
  urls = [
    "http://ekuiper:9081/rules/downsample_room_01/status",
    "http://ekuiper:9081/rules/downsample_room_02/status",
    "http://ekuiper:9081/rules/downsample_room_03/status",
    "http://ekuiper:9081/rules/downsample_room_04/status",
    "http://ekuiper:9081/rules/downsample_room_05/status",
    "http://ekuiper:9081/rules/downsample_room_06/status",
    "http://ekuiper:9081/rules/downsample_room_07/status",
    "http://ekuiper:9081/rules/downsample_room_08/status"
  ]
  data_format = "json_v2"
  name_override = "ekuiper_rule"
  [inputs.http.tags]
    component = "ekuiper"
  [[inputs.http.json_v2]]
    measurement_name = "ekuiper_rule"
    [[inputs.http.json_v2.field]]
      path = "status"
      type = "string"
    [[inputs.http.json_v2.field]]
      path = "lastStartTimestamp"
      type = "int"
      optional = true
    [[inputs.http.json_v2.field]]
      path = "lastStopTimestamp"
      type = "int"
      optional = true
    [[inputs.http.json_v2.field]]
      path = "source_*_records_in_total"
      type = "int"
      optional = true
    [[inputs.http.json_v2.field]]
      path = "source_*_records_out_total"
      type = "int"
      optional = true
    [[inputs.http.json_v2.field]]
      path = "source_*_process_latency_us"
      type = "int"
      optional = true
    [[inputs.http.json_v2.field]]
      path = "source_*_exceptions_total"
      type = "int"
      optional = true
    [[inputs.http.json_v2.field]]
      path = "source_*_connection_status"
      type = "int"
      optional = true
    [[inputs.http.json_v2.field]]
      path = "sink_*_records_in_total"
      type = "int"
      optional = true
    [[inputs.http.json_v2.field]]
      path = "sink_*_records_out_total"
      type = "int"
      optional = true
    [[inputs.http.json_v2.field]]
      path = "sink_*_exceptions_total"
      type = "int"
      optional = true

# Processor to extract rule name from URL
[[processors.regex]]
  order = 1
  namepass = ["ekuiper_rule"]
  [[processors.regex.tags]]
    key = "url"
    pattern = ".*/rules/([^/]+)/status"
    replacement = "${1}"
    result_key = "rule_name"

# NanoMQ Prometheus Metrics
[[inputs.prometheus]]
  interval = "15s"
  urls = ["http://nanomq:8081/api/v4/prometheus"]
  username = "nano"
  password = "public"
  metric_version = 2
  name_override = "nanomq_metrics"
  [inputs.prometheus.tags]
    component = "nanomq"

## ------------------------------------------------------------
## OUTPUTS
## ------------------------------------------------------------

# InfluxDB v2 Output - Sensor Data
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "smart-building-token-2026"
  organization = "smart-building"
  bucket = "sensor_data"
  timeout = "5s"
  namepass = ["sensor_telemetry"]

# InfluxDB v2 Output - eKuiper Monitoring
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "smart-building-token-2026"
  organization = "smart-building"
  bucket = "monitoring_ekuiper"
  timeout = "5s"
  namepass = ["ekuiper_rule"]
  tagexclude = ["url"]

# InfluxDB v2 Output - NanoMQ Monitoring
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "smart-building-token-2026"
  organization = "smart-building"
  bucket = "monitoring_nanomq"
  timeout = "5s"
  namepass = ["nanomq_metrics"]
